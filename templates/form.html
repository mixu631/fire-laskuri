<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FIRE Laskuri</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 2em auto;
      padding: 0 1em;
      color: #222;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 1em;
    }
    label {
      display: block;
      margin-top: 1.2em;
      font-weight: bold;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 0.5em;
      margin-top: 0.3em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    .form-section {
      margin-bottom: 2em;
    }
    .button-row {
      display: flex;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    #presetMessage {
      margin-top: 0.5em;
      font-weight: bold;
    }
    .tooltip {
      font-size: 0.85em;
      color: #666;
      font-weight: normal;
    }
    .dynamic-group {
      display: flex;
      gap: 0.5em;
      margin-top: 0.3em;
    }
    .dynamic-group input {
      width: 45%;
    }
    .dynamic-group button {
      width: auto;
    }
  </style>
</head>
<body>
  <h1>FIRE Laskuri</h1>

  <form method="POST" action="/" onsubmit="serializeDynamicFields()">

    <!-- Main inputs -->
    <div class="form-section">
      <label>Years to forecast:
        <span class="tooltip">Total years to simulate</span>
        <input type="number" name="years" value="30" required>
      </label>
      <label>Starting capital (‚Ç¨):
        <input type="number" name="starting_capital" value="10000" required>
      </label>
      <label>Starting loan (‚Ç¨):
        <input type="number" name="starting_loan" value="0" required>
      </label>
      <label>Expected annual return (%):
        <span class="tooltip">Before inflation</span>
        <input type="number" step="0.1" name="static_return" value="7" required>
      </label>
      <label>Annual investment (‚Ç¨):
        <input type="number" name="static_investment" value="1000" required>
      </label>
      <label>Annual new loan (‚Ç¨):
        <input type="number" name="static_new_loan" value="0" required>
      </label>
      <label>Annual inflation rate (%):
        <input type="number" step="0.1" name="inflation_rate" value="2" required>
      </label>
      <label>Annual loan interest rate (%):
        <input type="number" step="0.1" name="loan_interest_rate" value="0" required>
      </label>
      <label>Net wealth target (‚Ç¨):
        <input type="number" name="net_target" value="500000">
      </label>
      <label>Gross wealth target (‚Ç¨):
        <input type="number" name="gross_target" value="600000">
      </label>
      <label>Annual net return goal (‚Ç¨):
        <input type="number" name="gain_target" value="25000">
      </label>
    </div>

    <!-- Dynamic injections -->
    <div class="form-section">
      <label>Cash Injections:</label>
      <div id="cashFields"></div>
      <button type="button" onclick="addRow('cashFields')">‚ûï Add</button>

      <label>Debt Injections:</label>
      <div id="debtFields"></div>
      <button type="button" onclick="addRow('debtFields')">‚ûï Add</button>

      <label>Withdrawals:</label>
      <div id="withdrawalFields"></div>
      <button type="button" onclick="addRow('withdrawalFields')">‚ûï Add</button>

      <label>Debt Repayments:</label>
      <div id="repaymentFields"></div>
      <button type="button" onclick="addRow('repaymentFields')">‚ûï Add</button>
    </div>

    <!-- Preset controls inside form -->
    <div class="form-section">
      <label for="presetSelector">Choose a Preset:</label>
      <select id="presetSelector" onchange="loadPreset(this.value)">
        <option value="">-- Select a Preset --</option>
        {% for name in preset_names %}
        <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>

      <label for="presetName">Preset Name:</label>
      <input type="text" id="presetName" name="presetName" placeholder="Enter preset name">

      <div class="button-row">
        <button type="button" onclick="savePreset()">üíæ Save as New</button>
        <button type="button" onclick="updatePreset()">üí° Update Selected</button>
        <button type="button" onclick="deletePreset()">üóëÔ∏è Delete</button>
      </div>

      <p id="presetMessage"></p>
    </div>

    <!-- Hidden fields for dynamic data -->
    <input type="hidden" name="cash_injections_json" id="cash_injections_json">
    <input type="hidden" name="debt_injections_json" id="debt_injections_json">
    <input type="hidden" name="withdrawals_json" id="withdrawals_json">
    <input type="hidden" name="debt_repayments_json" id="debt_repayments_json">

    <button type="submit">Run Forecast</button>
  </form>

  <!-- JavaScript -->
  <script>
    function setMessage(text, success = true) {
      const el = document.getElementById("presetMessage");
      el.textContent = text;
      el.style.color = success ? "#007700" : "#cc0000";
    }

    function savePreset() {
      console.log("savePreset() called");
      const form = document.querySelector("form");
      const name = document.getElementById("presetName").value;
      if (!name) return setMessage("Enter a preset name.", false);
      const formData = new FormData(form);
      formData.append("action", "save_preset");
      fetch("/", { method: "POST", body: formData })
        .then(() => setMessage("‚úÖ Preset saved."))
        .then(() => setTimeout(() => window.location.reload(), 1000));
    }

    function updatePreset() {
      const form = document.querySelector("form");
      const name = document.getElementById("presetSelector").value;
      if (!name) return setMessage("Select a preset to update.", false);
      const formData = new FormData(form);
      formData.append("action", "update_preset");
      formData.append("presetName", name);
      fetch("/", { method: "POST", body: formData })
        .then(() => setMessage("‚úÖ Preset updated."))
        .then(() => setTimeout(() => window.location.reload(), 1000));
    }

    function deletePreset() {
      const name = document.getElementById("presetSelector").value;
      if (!name) return setMessage("Select a preset to delete.", false);
      fetch(`/delete_preset/${name}`, { method: "DELETE" })
        .then(() => setMessage("üóëÔ∏è Preset deleted."))
        .then(() => setTimeout(() => window.location.reload(), 1000));
    }

    function loadPreset(name) {
      if (!name) return;
      fetch(`/load_preset/${name}`)
        .then(res => res.json())
        .then(data => {
          for (const [key, value] of Object.entries(data)) {
            const el = document.querySelector(`[name="${key}"]`);
            if (el) el.value = value;
          }
          document.getElementById("presetName").value = name;
          setMessage("‚úÖ Preset loaded.");
        });
    }

    function addRow(containerId) {
      const div = document.createElement("div");
      div.classList.add("dynamic-group");
      div.innerHTML = '<input type="number" placeholder="Year" required> <input type="number" placeholder="Amount (‚Ç¨)" required> <button type="button" onclick="this.parentElement.remove()">‚ùå</button>';
      document.getElementById(containerId).appendChild(div);
    }

    function serializeDynamicFields() {
      const mapFields = (containerId) => {
        const entries = {};
        document.getElementById(containerId).querySelectorAll("div").forEach(div => {
          const [yearInput, valueInput] = div.querySelectorAll("input");
          const year = parseInt(yearInput.value);
          const value = parseFloat(valueInput.value);
          if (!isNaN(year) && !isNaN(value)) {
            entries[year] = value;
          }
        });
        return JSON.stringify(entries);
      };
      document.getElementById("cash_injections_json").value = mapFields("cashFields");
      document.getElementById("debt_injections_json").value = mapFields("debtFields");
      document.getElementById("withdrawals_json").value = mapFields("withdrawalFields");
      document.getElementById("debt_repayments_json").value = mapFields("repaymentFields");
    }
  </script>
</body>
</html>

